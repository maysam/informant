{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 text-center">
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        {% if user %}
            <div class="welcome-container">
                <img src="{{ user.photo_url }}" alt="Profile Photo" class="profile-photo" onerror="this.src='{{ url_for('static', filename='default-avatar.png') }}'">
                <h2>Welcome, {{ user.first_name }}!</h2>
                {% if user.username %}
                    <p class="username">@{{ user.username }}</p>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="btn btn-danger mt-3">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        {% else %}
            <h2>Welcome to Telegram Login</h2>
            <p>Please log in using your Telegram account:</p>
            
            <form action="{{ url_for('telegram_login') }}" method="post" id="login-form">
                <script 
                    async 
                    src="https://telegram.org/js/telegram-widget.js?22" 
                    data-telegram-login="{{ bot_username }}" 
                    data-size="large" 
                    data-radius="8"
                    data-onauth="onTelegramAuth(user)"
                    data-request-access="write">
                </script>
                
                <input type="hidden" name="id" id="id">
                <input type="hidden" name="first_name" id="first_name">
                <input type="hidden" name="last_name" id="last_name">
                <input type="hidden" name="username" id="username">
                <input type="hidden" name="photo_url" id="photo_url">
                <input type="hidden" name="auth_date" id="auth_date">
                <input type="hidden" name="hash" id="hash">
                
                <div class="form-check mt-3">
                    <input type="checkbox" class="form-check-input" id="remember_me" name="remember_me">
                    <label class="form-check-label" for="remember_me">Remember me for 24 hours</label>
                </div>
            </form>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function onTelegramAuth(user) {
    console.log('Telegram auth data:', user);  // Debug log
    
    // Map all possible user fields
    const fields = {
        'id': 'id',
        'first_name': 'first_name',
        'last_name': 'last_name',
        'username': 'username',
        'photo_url': 'photo_url',
        'auth_date': 'auth_date',
        'hash': 'hash'
    };
    
    // Set form values, with fallbacks for optional fields
    for (const [formId, userField] of Object.entries(fields)) {
        const element = document.getElementById(formId);
        if (element) {
            element.value = user[userField] || '';
        }
    }
    
    document.getElementById('login-form').submit();
}
</script>
{% endblock %}
